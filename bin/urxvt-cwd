#!/bin/bash

# Packages required: xdotool
#   - x window tool to obtain active window name and pid

fallback_start_urxvt() {
    urxvt &
    exit 1
}

which_cmd() {
    cmd=$(which $1 2>&1 > /dev/null)
    result=$?
    if [ $result -ne 0 ]; then
        fallback_start_urxvt
    fi
}

find_zsh_proc() {
    for i in $@; do
        if [ $(ps -p $i -o comm=) == "zsh" ]; then
            echo $i
            return
        fi
    done
}

get_cwd() {
    local pid=$(xdotool getactivewindow getwindowpid)
    local child_pids=$(pgrep -P $pid)
    local zsh_pid=$(find_zsh_proc $child_pids)
    local cwd=$(readlink -e /proc/$zsh_pid/cwd)
    if [ -d $cwd ]; then echo $cwd; fi
}

which_cmd xdotool

name=$(xdotool getactivewindow getwindowname)

if [ $name == "urxvt" ]; then
    cwd=$(get_cwd)
    urxvt -cd $cwd &
else
    fallback_start_urxvt
fi
